@{
    ViewData["Title"] = "Cloud Image Uploader";
}

<div class="upload-container">
    <h1>🖼️ Cloud Image Uploader</h1>

    <!-- File Upload Form with enhanced styling -->
    <form asp-action="Upload" method="post" enctype="multipart/form-data" id="uploadForm" onsubmit="showUploadSpinner()">
        <div class="file-input-group">
            <!-- File input with image preview capability -->
            <input type="file" name="file" class="form-control" accept="image/*" required />
            <button type="submit" class="btn-upload">
                <span id="uploadButtonText">📤 Upload File</span>
                <!-- Spinner shown during upload -->
                <span id="uploadSpinner" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                </span>
            </button>
        </div>
        <!-- Help text with supported formats and limitations -->
        <small style="opacity: 0.9;">Supported formats: JPG, PNG, WebP • Max size: 10 MB • Link expires in 10 minutes</small>
    </form>
</div>

<!-- Success Message with Share Link and Actions -->
@if (TempData["Success"] != null)
{
    <div class="alert-with-icon alert-success">
        <span class="alert-icon">✅</span>
        <div class="flex-grow-1">
            <strong>@TempData["Success"]</strong>
            <div class="share-section" style="margin-top: 15px; border: none; padding: 0;">
                <div style="color: #155724;">
                    <!-- Share link section with copy functionality -->
                    <strong>📎 Shareable Link:</strong>
                    <div class="share-link-box">
                        <a id="shareLink" href="@TempData["ShareUrl"]" target="_blank">@TempData["ShareUrl"]</a>
                    </div>
                    <!-- Expiration timer warning -->
                    <div class="expiration-timer">
                        ⏱️ Link expires in <strong>10 minutes</strong> - act fast!
                    </div>
                    <!-- Action buttons for file management -->
                    <div class="button-group">
                        <button id="copyBtn" class="btn-action btn-copy" onclick="copyShareLink(event)">
                            📋 Copy Link
                        </button>
                        <a href="@TempData["ShareUrl"]" class="btn-action btn-download" target="_blank">
                            ⬇️ Download
                        </a>
                        <button id="deleteBtn" class="btn-action btn-delete" onclick="deleteFile(event, '@TempData["FileId"]')">
                            🗑️ Delete & Revoke Access
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- Error Message with Icon -->
@if (TempData["Error"] != null)
{
    <div class="alert-with-icon alert-danger">
        <span class="alert-icon">❌</span>
        <div>
            <strong>Upload failed:</strong> @TempData["Error"]
        </div>
    </div>
}

<!-- Recent Uploads Table with Actions -->
@if (ViewBag.RecentUploads != null && ViewBag.RecentUploads.Count > 0)
{
    <div class="recent-uploads-container">
        <h4>📋 Recent Uploads</h4>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Uploaded</th>
                        <th>Expires In</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var file in ViewBag.RecentUploads)
                    {
                        <!-- Calculate remaining time until expiration (10 minute window) -->
                        var timeRemaining = file.UploadTime.AddMinutes(10) - DateTime.UtcNow;
                        var isExpired = timeRemaining.TotalSeconds <= 0;
                        var expiresInText = isExpired ? "Expired" : $"{(int)timeRemaining.TotalMinutes}m {timeRemaining.Seconds}s";

                        <tr style="@(isExpired ? "opacity: 0.5;" : "")">
                            <td>
                                <strong>@file.FileName</strong>
                            </td>
                            <td>@((file.FileSize / 1024.0).ToString("F1")) KB</td>
                            <td>@file.UploadTime.ToLocalTime().ToString("g")</td>
                            <td>
                                @if (isExpired)
                                {
                                    <!-- Expired file indicator -->
                                    <span style="color: #dc3545; font-weight: 600;">⏰ @expiresInText</span>
                                }
                                else
                                {
                                    <!-- Active file timer -->
                                    <span style="color: #28a745; font-weight: 600;">⏱️ @expiresInText</span>
                                }
                            </td>
                            <td>
                                @if (!isExpired)
                                {
                                    <!-- Delete button for active files only -->
                                    <button class="btn-action btn-delete" onclick="deleteFile(event, '@file.FileId')" style="padding: 6px 12px; font-size: 0.85rem;">
                                        🗑️ Delete
                                    </button>
                                }
                                else
                                {
                                    <!-- Disabled state for expired files -->
                                    <span style="color: #999;">No actions</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<script>
    // Show loading spinner during file upload
    // Provides immediate visual feedback that the upload is in progress
    function showUploadSpinner() {
        const buttonText = document.getElementById('uploadButtonText');
        const spinner = document.getElementById('uploadSpinner');
        buttonText.style.display = 'none';
        spinner.style.display = 'inline';
    }

    // Copy the shareable link to clipboard securely
    // Uses modern Clipboard API and provides user feedback
    // Properly passes event to access the button element
    function copyShareLink(event) {
        event.preventDefault();
        const link = document.getElementById('shareLink').href;
        
        // Use Clipboard API to securely copy the link
        navigator.clipboard.writeText(link).then(() => {
            // Provide visual feedback when copy succeeds
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✅ Copied!';
            button.style.backgroundColor = '#28a745';
            
            // Reset button after 2 seconds
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = '';
            }, 2000);
        }).catch(() => {
            alert('Failed to copy link. Please try again or copy manually.');
            console.error('Clipboard copy failed');
        });
    }

    // Delete a file and revoke access to all shares
    // Requires confirmation to prevent accidental deletion
    // Properly passes event to access the button element
    function deleteFile(event, fileId) {
        event.preventDefault();
        
        // Confirmation dialog to prevent accidental deletions
        if (!confirm('Are you sure you want to delete this file? Access will be revoked for all shares.')) {
            return;
        }

        // Show confirmation that deletion is in progress
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = '⏳ Deleting...';

        // Submit delete request via POST to the server
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete/${fileId}`;

        // Add CSRF token for security
        // This prevents cross-site request forgery attacks
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        if (token) {
            form.appendChild(token.cloneNode(true));
        }

        document.body.appendChild(form);
        form.submit();
    }
</script>